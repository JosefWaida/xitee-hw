# Use the almalinux:minimal image as the base
FROM jupyter/minimal-notebook:x86_64-ubuntu-22.04

# Set environment variables for the new users
ENV ANSIBLE_USER_NAME ansible
ENV ANSIBLE_USER_HOME /home/$ANSIBLE_USER_NAME
ENV XITEE_USER_NAME xitest
ENV XITEE_USER_HOME /home/$XITEE_USER_NAME
ENV TEST_USER_NAME test
ENV TEST_USER_HOME /home/$TEST_USER_NAME

# Install required packages
USER root
RUN apt -y update && \
    apt -y install \
    openssh-server \
    sudo \
    python3 \
    python3-pip && \
    apt clean all

# Create the new users and their home directories
RUN useradd -m -d $ANSIBLE_USER_HOME -s /bin/bash $ANSIBLE_USER_NAME && \
    echo "$ANSIBLE_USER_NAME ALL=(ALL) NOPASSWD:/usr/bin/ansible" >> /etc/sudoers && \
    useradd -m -d $XITEE_USER_HOME -s /bin/bash $XITEE_USER_NAME && \
    echo "$XITEE_USER_NAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers \
    useradd -m -d $TEST_USER_HOME -s /bin/bash $TEST_USER_NAME && \
    echo "$TEST_USER_NAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Set up SSH for both users
RUN mkdir -p /var/run/sshd && \
    mkdir -p $ANSIBLE_USER_HOME/.ssh && \
    mkdir -p $XITEE_USER_HOME/.ssh && \
    mkdir -p $TEST_USER_HOME/.ssh && \
    chmod 700 $ANSIBLE_USER_HOME/.ssh && \
    chmod 700 $XITEE_USER_HOME/.ssh \ 
    chmod 700 $TEST_USER_HOME/.ssh

# Add SSH keys for xitee_user (replace these with your actual keys)
RUN touch $XITEE_USER_HOME/.ssh/authorized_keys && \
    echo "XYZ" >> $XITEE_USER_HOME/.ssh/authorized_keys && \
    echo "xzy" >> $XITEE_USER_HOME/.ssh/authorized_keys && \
    chmod 600 $XITEE_USER_HOME/.ssh/authorized_keys && \
    chown -R $XITEE_USER_NAME:$XITEE_USER_NAME $XITEE_USER_HOME/.ssh

    RUN touch $TEST_USER_HOME/.ssh/authorized_keys && \
    echo "your-public-key-here" >> $TEST_USER_HOME/.ssh/authorized_keys && \
    chmod 600 $TEST_USER_HOME/.ssh/authorized_keys && \
    chown -R $TEST_USER_NAME:$TEST_USER_NAME $TEST_USER_HOME/.ssh

# Install Ansible
RUN pip3 install --no-cache-dir ansible

# Expose SSH port
EXPOSE 22

# Start the SSH service
CMD ["/usr/sbin/sshd", "-D"]
