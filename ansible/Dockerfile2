# Use the almalinux:minimal image as the base
FROM almalinux:minimal

# Set environment variables for the new user
ENV USER_NAME ansible
ENV USER_HOME /home/$USER_NAME
ENV USER_NAME_XITEE xitest
ENV USER_NAME_XITEE_HOME /home/$USER_NAME_XITEE

# Install required packages
RUN dnf update -y && \
    dnf install -y \
    openssh-server \
    openssh-clients \
    sudo \
    python3 \
    python3-pip && \
    dnf clean all

# Create the new user
RUN useradd -m -d $USER_HOME -s /bin/bash $USER_NAME && \
    echo "$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/ansible" >> /etc/sudoers
RUN useradd -m -d $USER_NAME_XITEE_HOME -s /bin/bash $USER_NAME_XITEE && \
    echo "$USER_NAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Set up SSH
RUN mkdir -p /var/run/sshd && \
    mkdir -p $USER_HOME/.ssh && \
    chmod 700 $USER_HOME/.ssh

# Add the two SSH keys (replace these with your actual keys)
RUN echo "ssh-ed25519
AAAAC3NzaC1lZDI1NTE5AAAAIOH/TlOb8TAXiMhN8u7VNqPC7W2hrhygm/1BZBZZp0q
o marek@GUADALAJARA-WSL" >> $USER_NAME_XITEE_HOME/.ssh/authorized_keys && \
    echo "ssh-ed25519
AAAAC3NzaC1lZDI1NTE5AAAAIP7FHrfu37DbzYBs6T3P/aq+XOeJAtu8Ftl1/3g1EN/K
tkuba" >> $USER_NAME_XITEE_HOME/.ssh/authorized_keys && \
    chmod 600 $USER_NAME_XITEE_HOME/.ssh/authorized_keys && \
    chown -R $USER_NAME_XITEE:$UUSER_NAME_XITEE $USER_NAME_XITEE_HOME/.ssh

# Install Ansible
RUN pip3 install --no-cache-dir ansible

# Expose SSH port
EXPOSE 22

# Start the SSH service
CMD ["/usr/sbin/sshd", "-D"]
